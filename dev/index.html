<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · ROMS.jl</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href>ROMS.jl</a></span></div><form class="docs-search" action="search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Tutorial"><span>Tutorial</span></a></li></ul></li><li><a class="tocitem" href="reference/">Reference</a></li><li><a class="tocitem" href="plots/">Plots</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Alexander-Barth/ROMS.jl/blob/master/docs/src/index.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p>This package allows to setup necessary files for the <a href="https://www.myroms.org/">ROMS ocean model</a>.</p><h2 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h2><p>This tutorial is for students following the ULiège lecture OCEA0036-1 but might be useful for others as well.</p><h3 id="Using-for-the-first-time-a-Linux-(or-UNIX-like)-environment?"><a class="docs-heading-anchor" href="#Using-for-the-first-time-a-Linux-(or-UNIX-like)-environment?">Using for the first time a Linux (or UNIX-like) environment?</a><a id="Using-for-the-first-time-a-Linux-(or-UNIX-like)-environment?-1"></a><a class="docs-heading-anchor-permalink" href="#Using-for-the-first-time-a-Linux-(or-UNIX-like)-environment?" title="Permalink"></a></h3><ul><li><p>Essential shell commands:</p><ul><li><code>ls</code>: list all files and directories</li><li><code>cd directory_name</code>: change directory</li><li><code>pwd</code>: print the name of the current working directory</li><li><code>mkdir</code>: create a directory</li><li><code>cp source destination</code>: copy a file</li><li><code>mv source destination</code>: move a file</li><li><code>rm file</code>: remove a file (permanently)</li><li><code>find directory_name -name &quot;*foo*&quot;</code>: find all files under <code>directory_name</code> (including sub-directories) whose name contains <code>foo</code>.</li><li><code>diff file1 file2</code>: compare two text files</li><li><code>gedit filename &amp;</code>, <code>pluma filename &amp;</code> or <code>editor filename &amp;</code>: open a text editor to edit a file.</li></ul></li><li><p>Shell keyboard short cuts (also applicable to a julia session):</p><ul><li><code>up-arrow</code>: show previous command (similarly <code>down-arrow</code> show next command)</li><li><code>TAB</code>: complete command or file/directory name if it is unambiguous</li><li><code>TAB TAB</code>: show all possible commands or file/directory name if multiple possibilities exists</li><li><code>Control-R</code> and type <code>some_string</code>: Search for a previously executed command which includes <code>some_string</code>.</li><li><code>Control-C</code>: cancel the previous command (be careful to not to cancel your text editor session)</li><li><code>Control-D</code>: close a shell session</li></ul></li><li><p>Special directories:</p><ul><li><code>.</code>: current directory</li><li><code>..</code>: parent directory</li><li><code>~</code>: home directory</li></ul></li><li><p>Please pay attention to the difference between upper- and lowercase letters</p></li><li><p>Presence and absence of white space is also significant</p></li><li><p>Avoid using directories and file names with a space in them, otherwise you need to put the directory in quotes (single or double quotes) or use black-slash (<code>\\</code>) in front of the white space. For example, shell command <code>cd My Directory Name</code> does not work, use one of the following instead:</p></li></ul><pre><code class="language-bash hljs">cd &quot;My Directory Name&quot;
cd &#39;My Directory Name&#39;
cd My\ Directory\ Name</code></pre><ul><li>Check out the <a href="https://diyhacking.com/linux-commands-for-beginners/">basic shell commands</a> and <a href="https://ryanstutorials.net/linuxtutorial/">this tutorial</a></li></ul><h3 id="Registration"><a class="docs-heading-anchor" href="#Registration">Registration</a><a id="Registration-1"></a><a class="docs-heading-anchor-permalink" href="#Registration" title="Permalink"></a></h3><p>Please register at:</p><ul><li><a href="https://www.myroms.org/index.php?page=RomsCode">ROMS (Regional Ocean Modeling System)</a>.</li><li><a href="http://marine.copernicus.eu/services-portfolio/register-now/">CMEMS (Copernicus Marine Environment Monitoring Service)</a></li></ul><p>To generate new forcing fields, register at (optional):</p><ul><li><a href="https://apps.ecmwf.int/registration/">ECMWF (European Centre for Medium-Range Weather Forecasts)</a>. To access the operational forecast on the MARS service you will need a special permissions granted by your national weather service (in Europe). The default permission will let you access e.g. ERA5 dataset.</li></ul><h3 id="Required-software"><a class="docs-heading-anchor" href="#Required-software">Required software</a><a id="Required-software-1"></a><a class="docs-heading-anchor-permalink" href="#Required-software" title="Permalink"></a></h3><p>The tutorial can be run either:</p><ol><li>on your computer using a preconfigured virtual machine</li><li>on the machines of the ULiège computer room</li><li>directly on your computer (but all software has to be installed beforehand) if you are using Ubuntu/Debian. Other Linux OS will work too, but the installation instructions must be adapted. Mac OS and Windows (using e.g. Windows Subsystem for Linux) might work too. But if you are not using Linux, it is preferable to the the virtual machine.</li></ol><h4 id="Preconfigured-virtual-machine"><a class="docs-heading-anchor" href="#Preconfigured-virtual-machine">Preconfigured virtual machine</a><a id="Preconfigured-virtual-machine-1"></a><a class="docs-heading-anchor-permalink" href="#Preconfigured-virtual-machine" title="Permalink"></a></h4><p>A preconfigured virtual machine is available <a href="http://data-assimilation.net/upload/OCEA0036/Ubuntu-20.04-MATE-Julia-ROMS.ova">here</a>.</p><ul><li>Virtual Box requires the <a href="https://learn.microsoft.com/en-US/cpp/windows/latest-supported-vc-redist?view=msvc-170">Microsoft Visual C++ Redistributable</a> which should be installed before (as of Virtual Box version 7.0.4).</li><li>Virtual Box can be installed from <a href="https://www.virtualbox.org/wiki/Downloads">here</a>.</li><li>The OVA file must be imported in Virtual Box as explained in the <a href="https://docs.oracle.com/cd/E26217_01/E26796/html/qs-import-vm.html">documentation</a>.</li></ul><p>The account <code>student</code> has the password <code>tritro</code>. In this virtual machine, all software is already pre-installed, but must be updated using this shell commands:</p><pre><code class="language-bash hljs">cd .julia/dev/ROMS
git pull</code></pre><p>Then open a julia session (typing the <code>julia</code> command), and update all packages with:</p><pre><code class="language-julia hljs">using Pkg
Pkg.update()</code></pre><p>Note, it is not necessary of this tutorial to update the whole operating system.</p><h4 id="Installation-on-Ubuntu/Linux-(or-UNIX-like-operating-systems)"><a class="docs-heading-anchor" href="#Installation-on-Ubuntu/Linux-(or-UNIX-like-operating-systems)">Installation on Ubuntu/Linux (or UNIX-like operating systems)</a><a id="Installation-on-Ubuntu/Linux-(or-UNIX-like-operating-systems)-1"></a><a class="docs-heading-anchor-permalink" href="#Installation-on-Ubuntu/Linux-(or-UNIX-like-operating-systems)" title="Permalink"></a></h4><p>If you do not use this virtual machine the following software need to be installed:</p><ul><li><a href="https://julialang.org/downloads/">Julia</a>. Under Linux, you can install Julia with the following shell commands:</li></ul><pre><code class="language-bash hljs">cd /opt/
sudo wget https://julialang-s3.julialang.org/bin/linux/x64/1.8/julia-1.8.2-linux-x86_64.tar.gz
sudo tar -xvf julia-1.8.2-linux-x86_64.tar.gz
sudo rm julia-1.8.2-linux-x86_64.tar.gz
sudo ln -s /opt/julia-1.8.2/bin/julia /usr/local/bin/julia</code></pre><p>where <code>1.8.2</code> should be replaced by the version number of the current stable release. More information is available <a href="https://julialang.org/downloads/platform/">here</a>.</p><p>Under Linux, you need to install also <code>python3-matplotlib</code> for PyPlot. On Debian/Ubuntu, this packages can be installed by this command:</p><pre><code class="language-bash hljs">sudo apt install python3-matplotlib</code></pre><ul><li>Julia package, <code>PyPlot</code>, <code>NCDatasets</code>, <code>ROMS</code> which can be installed by:</li></ul><pre><code class="language-julia hljs">using Pkg
Pkg.add(&quot;PyPlot&quot;)
Pkg.add(&quot;NCDatasets&quot;)
Pkg.develop(url=&quot;https://github.com/Alexander-Barth/ROMS.jl&quot;)</code></pre><ul><li>ROMS source. This example uses the version 4.0 of ROMS. We assume that the ROMS source is copied in <code>~/src/roms</code>:</li></ul><pre><code class="language-bash hljs">mkdir ~/src/
cd ~/src/
git clone &quot;https://www.myroms.org/git/src&quot; roms
cd roms
git checkout roms-4.0</code></pre><p>For the git command, you will cneed to provide your ROMS username and password.</p><p>Other required software typically available from a package manager:</p><ul><li>A Fortran 90 compiler (e.g. gfortran)</li><li>GNU make</li><li>NetCDF (including headers files for development and the tools <code>ncdump</code>, <code>nf-config</code>)</li><li>perl</li><li>Python and pip</li><li>MPI (optional)</li><li>git (optional)</li></ul><p>Note that all libraries (NetCDF and MPI) must be compiled with the same Fortran compiler.</p><p>On Windows, various ways exist to install gfortran, GNU make and other dependencies:</p><ul><li>Windows Subsystem for Linux<ul><li><a href="https://msdn.microsoft.com/en-us/commandline/wsl/install_guide">Installation guide</a></li><li><a href="https://docs.microsoft.com/en-us/windows/wsl/faq">FAQ (in particular exchanging files)</a></li></ul></li><li><a href="https://www.cygwin.com/">Cygwin</a></li><li><a href="http://www.mingw.org/">MINGW</a></li><li>Linux virtual machine using e.g. VirtualBox</li><li>...</li></ul><p>On MacOS X:</p><ul><li>Homebrew https://brew.sh/</li><li>...</li></ul><p>On Debian/Ubuntu, these packages can be installed by this command:</p><pre><code class="language-bash hljs">sudo apt install gfortran make perl netcdf-bin libnetcdff-dev libopenmpi-dev openmpi-bin git python3-pip python3-setuptools unzip</code></pre><ul><li>For CMEMS data, you need the python package <code>motuclient</code> (<a href="https://github.com/clstoulouse/motu-client-python#Installation">installation instructions</a>).</li></ul><p>For example:</p><pre><code class="language-bash hljs"># to install a specific version use
python3 -m pip install --user motuclient==1.8.6
# or to install the latest version use:
# python3 -m pip install --user motuclient</code></pre><p>I advice you to use version 1.8.6 of motuclient because of <a href="https://github.com/clstoulouse/motu-client-python/issues/27">this issue</a>. Normally you will see the warning <code>WARNING: The script motuclient is installed in &#39;.../.local/bin&#39; which is not on PATH. Consider adding this directory to PATH</code>. You need to add the following line to the file <code>.bashrc</code> located in your home directory (at the end of this file on a separate line):</p><pre><code class="nohighlight hljs">export PATH=&quot;$HOME/.local/bin:$PATH&quot;</code></pre><p>In a terminal execute the following so that this change takes effect:</p><pre><code class="language-bash hljs">source ~/.bashrc</code></pre><ul><li>For ECMWF data, you need the pacakge <code>ecmwf-api-client</code> (optional). Follow the <a href="https://confluence.ecmwf.int/display/WEBAPI/Access+ECMWF+Public+Datasets">installation instructions</a> (including the ECMWF key). For questions related to ECMWF data access please also consult <a href="https://www.ecmwf.int/en/forecasts/access-forecasts/ecmwf-web-api">this document</a>.</li><li>Note that the ECMWF key is different from your ECMWF password.</li></ul><h3 id="Check-your-environment"><a class="docs-heading-anchor" href="#Check-your-environment">Check your environment</a><a id="Check-your-environment-1"></a><a class="docs-heading-anchor-permalink" href="#Check-your-environment" title="Permalink"></a></h3><ul><li>Check julia version:</li></ul><pre><code class="language-bash hljs">julia --version</code></pre><ul><li>Check the Fortran Compiler</li></ul><pre><code class="language-bash hljs">gfortran --version</code></pre><ul><li>MPI</li></ul><pre><code class="language-bash hljs">mpif90 --version
mpirun --help</code></pre><ul><li>NetCDF</li></ul><pre><code class="language-bash hljs">nf-config --all</code></pre><p><em>or</em> the old name <code>nc-config</code>:</p><pre><code class="language-bash hljs">nc-config --all</code></pre><p>If you have <code>nc-config</code> (with Fortran support) but not <code>nf-config</code>, you can run the following:</p><pre><code class="language-bash hljs">ln -s /usr/bin/nc-config $HOME/bin/nf-config</code></pre><p>Or set later the environemt variable <code>NF_CONFIG</code> to <code>nc-config</code>.</p><ul><li>Check the <code>motuclient</code> (it may return <code>vUnknown</code>, but it should not return <code>No module named motuclient</code>)</li></ul><pre><code class="language-bash hljs">motuclient --version</code></pre><p>These commands should return a basic usage info or the version number if they are correctly installed.</p><p>Check the presence of <code>ROMS.jl</code>, in a julia shell type:</p><pre><code class="language-julia hljs">using Pkg
Pkg.status()</code></pre><p>This gives you a list of installed packages which should include the package <code>ROMS</code>. Install <code>ROMS.jl</code> if necessary by:</p><pre><code class="language-julia hljs">using Pkg
Pkg.add(url=&quot;https://github.com/Alexander-Barth/ROMS.jl&quot;)</code></pre><h3 id="Data"><a class="docs-heading-anchor" href="#Data">Data</a><a id="Data-1"></a><a class="docs-heading-anchor-permalink" href="#Data" title="Permalink"></a></h3><ul><li>The full <a href="https://dox.ulg.ac.be/index.php/s/iEh7ompNdj8AN2p/download">GEBCO bathymetry</a> (the file <code>gebco_30sec_1.nc</code> is already included in the virtual machine)</li></ul><h3 id="Area"><a class="docs-heading-anchor" href="#Area">Area</a><a id="Area-1"></a><a class="docs-heading-anchor-permalink" href="#Area" title="Permalink"></a></h3><p>Choose an area:</p><ul><li><p>What interesting processes are present in your studied area? (note: now we all use the Ligurian Sea)</p></li><li><p>Are there in situ measurements available for your area? Look for temperature and salinity within your areas (for any time frame)</p><ul><li>Check with <a href="https://www.nodc.noaa.gov/OC5/SELECT/dbsearch/dbsearch.html">World Ocean Database</a></li><li><a href="http://marine.copernicus.eu/">CMEMS in situ Thematic Assemble Centre (TAC)</a></li></ul></li><li><p>Visualize a couple of downloaded profiles:</p><ul><li>Hints: in Julia you can use the package <a href="https://github.com/Alexander-Barth/NCDatasets.jl"><code>NCDatasets</code></a></li><li>How would you distribute the vertical resolution in your model represent this profile?</li></ul></li><li><p>Check that your longitude/latitude/time range model of your nested model is within longitude/latitude/time range of the outer model providing the boundary conditions</p></li><li><p>Choose the domain such to avoid unnecessary open ocean boundary conditions</p></li></ul><h3 id="Atmospheric-forcing-fields"><a class="docs-heading-anchor" href="#Atmospheric-forcing-fields">Atmospheric forcing fields</a><a id="Atmospheric-forcing-fields-1"></a><a class="docs-heading-anchor-permalink" href="#Atmospheric-forcing-fields" title="Permalink"></a></h3><ul><li>For the Ligurian Sea, necessary parameters have already been prepared and are available in the file <a href="https://dox.ulg.ac.be/index.php/s/nH8u2DrI1m9mMbC">ROMS-implementation.zip</a>. It containts data download the from</li></ul><p>the ECMWF operational archive (<code>Atmosphere/ecmwf_operational_archive_2018-12-01T00:00:00_2020-01-01T00:00:00.nc</code>). This NetCDF file needs to be converted by the julia function <code>ROMS.prepare_ecmwf</code>.</p><ul><li>The remaining of this section explained how to download data from the ECMWF operational archive (e.g. for a different domain). These instructions are not needed now.</li><li>Adapt the file name, longitude/latitude and time range (start one day earlier, and finish one day later) in <a href="https://github.com/Alexander-Barth/ROMS.jl/blob/master/examples/forcing_ecmwf.py"><code>forcing_ecmwf.py</code></a> and execute the script as follows:</li></ul><pre><code class="language-bash hljs">python3 forcing_ecmwf.py</code></pre><p>List of variables (*: quantities accumulated over the integration period (&quot;step&quot;))</p><table><tr><th style="text-align: right">NetCDF Variable name</th><th style="text-align: right">Description</th></tr><tr><td style="text-align: right">msl</td><td style="text-align: right">Mean sea level pressure</td></tr><tr><td style="text-align: right">u10</td><td style="text-align: right">10 metre U wind component</td></tr><tr><td style="text-align: right">v10</td><td style="text-align: right">10 metre V wind component</td></tr><tr><td style="text-align: right">t2m</td><td style="text-align: right">2 metre temperature</td></tr><tr><td style="text-align: right">d2m</td><td style="text-align: right">2 metre dewpoint temperature</td></tr><tr><td style="text-align: right">tcc</td><td style="text-align: right">Total cloud cover*</td></tr><tr><td style="text-align: right">sshf</td><td style="text-align: right">Surface sensible heat flux*</td></tr><tr><td style="text-align: right">strd</td><td style="text-align: right">Surface thermal radiation downwards*</td></tr><tr><td style="text-align: right">ssr</td><td style="text-align: right">Surface net solar radiation*</td></tr><tr><td style="text-align: right">str</td><td style="text-align: right">Surface net thermal radiation*</td></tr><tr><td style="text-align: right">ewss</td><td style="text-align: right">Eastward turbulent surface stress*</td></tr><tr><td style="text-align: right">nsss</td><td style="text-align: right">Northward turbulent surface stress*</td></tr><tr><td style="text-align: right">e</td><td style="text-align: right">Evaporation*</td></tr><tr><td style="text-align: right">ro</td><td style="text-align: right">Runoff*</td></tr><tr><td style="text-align: right">tp</td><td style="text-align: right">Total precipitation*</td></tr><tr><td style="text-align: right">sst</td><td style="text-align: right">Sea surface temperature</td></tr><tr><td style="text-align: right">par</td><td style="text-align: right">Photosynthetically active radiation at the surface*</td></tr></table><h3 id="Generate-initial,-boundary-conditions-and-forcing-files"><a class="docs-heading-anchor" href="#Generate-initial,-boundary-conditions-and-forcing-files">Generate initial, boundary conditions and forcing files</a><a id="Generate-initial,-boundary-conditions-and-forcing-files-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-initial,-boundary-conditions-and-forcing-files" title="Permalink"></a></h3><ul><li><p>Adapt the <a href="https://raw.githubusercontent.com/Alexander-Barth/ROMS.jl/master/test/example_config.jl"><code>example_config.jl</code></a> file and call it <code>yourdomain_config.jl</code> where you replace <code>yourdomain</code> by the the name of your domain (lowercase and without space). For the Ligurian Sea, use <code>liguriansea_config.jl</code>.</p><ul><li>Longitude/latitude bounding box</li><li>File paths</li><li>Time range</li><li>...</li></ul></li><li><p>For CMEMS boundary conditions:</p><ul><li>You may need to adapt <code>service_id</code>, <code>motu_server</code> and <code>mapping</code> (if the model domain is outside of the Mediterranean Sea)</li><li>Data will be downloaded and saved in NetCDF by &quot;chunks&quot; of 60 days in the folder <code>OGCM</code> under the content of the variable <code>basedir</code></li><li>You need to remove the files in this directory if you rerun the script with a different time range.</li></ul></li><li><p>Run in Julia</p></li></ul><pre><code class="language-julia hljs">include(&quot;yourdomain_config.jl&quot;)</code></pre><ul><li>Check the resulting files: bathymetry, initial conditions, boundary conditions, interpolated model (<code>clim</code> file) and visualize the these files along some sections.</li></ul><h3 id="ROMS-compilation"><a class="docs-heading-anchor" href="#ROMS-compilation">ROMS compilation</a><a id="ROMS-compilation-1"></a><a class="docs-heading-anchor-permalink" href="#ROMS-compilation" title="Permalink"></a></h3><ul><li>Create a directory (avoid directory names with spaces) for your model configuration</li><li>Compile ROMS:<ul><li>configure ROMS by creating a file <code>yourdomain.h</code> (e.g. <code>liguriansea.h</code> for the Ligurian Sea):</li></ul></li></ul><pre><code class="language-C hljs">#define UV_ADV                    /* turn ON advection terms */
#define UV_COR                    /* turn ON Coriolis term */
#define DJ_GRADPS                 /* Splines density  Jacobian (Shchepetkin, 2000) */
#define NONLIN_EOS                /* define if using nonlinear equation of state */
#define SALINITY                  /* define if using salinity */
#define SOLVE3D                   /* define if solving 3D primitive equations */
#define MASKING                   /* define if there is land in the domain */
#define TS_U3HADVECTION           /* Third-order upstream horizontal advection of tracers */
#define TS_C4VADVECTION           /* Fourth-order centered vertical advection of tracers */
#define TS_DIF2                   /* use to turn ON or OFF harmonic horizontal mixing  */
#define MIX_S_UV                  /* mixing along constant S-surfaces */
#define UV_VIS2                   /* turn ON Laplacian horizontal mixing */
#define AVERAGES
#define UV_QDRAG
#define MIX_S_TS

#define  MY25_MIXING
#ifdef MY25_MIXING
# define N2S2_HORAVG
# define KANTHA_CLAYSON
#endif

#define ANA_BSFLUX                /* analytical bottom salinity flux */
#define ANA_BTFLUX                /* analytical bottom temperature flux */
#define ANA_SSFLUX

#define BULK_FLUXES               /* turn ON bulk fluxes computation */
#define CLOUDS
#define LONGWAVE
#define SOLAR_SOURCE</code></pre><ul><li>Copy the script <code>build_roms.sh</code> to the directory <code>~/ROMS-implementation-test</code></li></ul><pre><code class="language-bash hljs">cd ~/ROMS-implementation-test
cp ~/src/roms/ROMS/Bin/build_roms.sh build_roms.sh</code></pre><ul><li>Copy it to this directory and adapt it. Here is a list of changes that I made highlighted with the <a href="https://en.wikipedia.org/wiki/Diff_utility#Unified_format">diff tool</a>.</li></ul><p>The lines in red have been replaced by the lines in green. The plus and minus signes indicates also what has been added or removed and the <code>@@</code> indicate line numbers. These markers do not have to be added manually to the file <code>build_roms.sh</code>.</p><pre><code class="language-diff hljs"> diff -u /home/abarth/src/roms/ROMS/Bin/build_roms.sh build_roms.sh
--- /home/abarth/src/roms/ROMS/Bin/build_roms.sh	2020-10-11 21:19:08.000000000 +0200
+++ build_roms.sh	2020-11-06 11:16:15.484841910 +0100
@@ -102,12 +102,12 @@
 # determine the name of the &quot;.h&quot; header file with the application
 # CPP definitions.

-export   ROMS_APPLICATION=UPWELLING
+export   ROMS_APPLICATION=LigurianSea

 # Set a local environmental variable to define the path to the directories
 # where all this project&#39;s files are kept.

-export        MY_ROOT_DIR=${HOME}/ocean/repository
+export        MY_ROOT_DIR=${HOME}
 export     MY_PROJECT_DIR=${PWD}

 # The path to the user&#39;s local current ROMS source code.
@@ -120,7 +120,7 @@
 # machine. This script is designed to more easily allow for differing paths
 # to the code and inputs on differing machines.

- export       MY_ROMS_SRC=${MY_ROOT_DIR}/trunk
+ export       MY_ROMS_SRC=${MY_ROOT_DIR}/src/roms

 # Set path of the directory containing makefile configuration (*.mk) files.
 # The user has the option to specify a customized version of these files
@@ -168,13 +168,13 @@

 #export        USE_OpenMP=on            # shared-memory parallelism

- export              FORT=ifort
-#export              FORT=gfortran
+# export              FORT=ifort
+export              FORT=gfortran
 #export              FORT=pgi

 #export         USE_DEBUG=on            # use Fortran debugging flags
  export         USE_LARGE=on            # activate 64-bit compilation
-#export       USE_NETCDF4=on            # compile with NetCDF-4 library
+export       USE_NETCDF4=on            # compile with NetCDF-4 library
 #export   USE_PARALLEL_IO=on            # Parallel I/O with NetCDF-4/HDF5

</code></pre><p>If you do not have the tool <code>nf-config</code>, you need to add this line <code>export NF_CONFIG=nc-config</code>.</p><p>For ROMS 4.0 and gfortran 11.2, you need to add <code>-fallow-argument-mismatch</code> to <code>FFLAGS</code> in <code>Compilers/Linux-gfortran.mk</code> from the ROMS source files. This is expected to be fixed in upcoming version of ROMS.</p><ul><li>Review your changes with:</li></ul><pre><code class="language-bash hljs">diff ~/src/roms/ROMS/Bin/build_roms.sh build_roms.sh</code></pre><ul><li>compile ROMS by running:</li></ul><pre><code class="language-bash hljs">./build_roms.sh -j 2</code></pre><ul><li>copy <code>varinfo.dat</code> from <code>~/src/roms/ROMS/External/varinfo.dat</code> in your directory for your simulation (e.g. <code>Simulation1</code>):</li></ul><pre><code class="language-bash hljs">cp ~/src/roms/ROMS/External/varinfo.dat .</code></pre><h3 id="ROMS-model-domain-configuration"><a class="docs-heading-anchor" href="#ROMS-model-domain-configuration">ROMS model domain configuration</a><a id="ROMS-model-domain-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#ROMS-model-domain-configuration" title="Permalink"></a></h3><ul><li>copy <code>roms.in</code> from <code>~/src/roms/User/External/roms.in</code> in the directory <code>~/ROMS-implementation-test</code>:</li></ul><pre><code class="language-bash hljs">cp  ~/src/roms/User/External/roms.in .</code></pre><ul><li><p>check the glossary at the end of this file for the meaning of the keys that we will change</p></li><li><p>when editing this file, do not use &quot;tabs&quot;.</p></li><li><p>adapt <code>MyAppCPP</code> and change it to <code>LIGURIANSEA</code></p></li><li><p>adapt file names <code>VARNAME</code>, <code>GRDNAME</code>, <code>ININAME</code>, <code>BRYNAME</code>, <code>CLMNAME</code>, <code>FRCNAME</code> and <code>NFFILES</code></p></li><li><p>also make sure that these variables are set (number of files with boundary conditions and climatology). If they do not exist, they need to be added (near <code>BRYNAME</code> for example).</p></li></ul><pre><code class="nohighlight hljs"> NBCFILES == 1
NCLMFILES == 1</code></pre><ul><li><p>change <code>Lm</code>, <code>Mm</code> and <code>N</code> based on the dimensions of your grid (make sure to read the glossary for these variable in <code>roms.in</code>)</p></li><li><p>read the desciption about &quot;lateral boundary conditions&quot; and adapt boundaries <code>LBC</code>:</p><ul><li>use closed (<code>Clo</code>) for boundaries without sea-point</li><li>for open boundaries:<ul><li>free-surface: Chapman implicit (<code>Cha</code>)</li><li>2D U/V-momentum: Flather (<code>Fla</code>)</li><li>3D U/V-momentum, temperature, salinity: Radiation with nudging (<code>RadNud</code>)</li><li>mixing TKE: Radiation (<code>Rad</code>)</li></ul></li></ul></li><li><p>set the starting time and time reference</p></li></ul><pre><code class="nohighlight hljs">DSTART = ...
TIME_REF =  18581117</code></pre><p>where <code>DSTART</code> is here the number of days since 1858-11-17 or November 17, 1858 (see also <a href="https://en.wikipedia.org/wiki/Julian_day#Variants">modified Julia day</a>). For instance the number of days since 2014-01-01 (year-month-day) can be computed by of following commands in Julia:</p><pre><code class="language-julia hljs">using Dates
Date(2020,1,1) - Date(1858,11,17)</code></pre><p>The inverse operation can be done with:</p><pre><code class="language-julia hljs">using Dates
Date(1858,11,17) + Day(58849)</code></pre><p>You can use <code>DateTime</code> if you want to specify hour, minutes or seconds.</p><ul><li>Adapt the length of a time step <code>DT</code> (in seconds) and number of time steps <code>NTIMES</code></li><li>Initially we choose:<ul><li><code>NTIMES</code> -&gt; number of time step corresponding to 2 days (e.g. <code>2*24*60*60/DT</code> where <code>DT</code> is the time steps in seconds)</li><li><code>NHIS</code>, <code>NAVG</code>-&gt; number of time steps corresponding to 1 hour</li><li><code>NRST</code> -&gt; number of time steps correspond to 1 hour</li></ul></li></ul><h3 id="Nudging-towards-&quot;climatology&quot;"><a class="docs-heading-anchor" href="#Nudging-towards-&quot;climatology&quot;">Nudging towards &quot;climatology&quot;</a><a id="Nudging-towards-&quot;climatology&quot;-1"></a><a class="docs-heading-anchor-permalink" href="#Nudging-towards-&quot;climatology&quot;" title="Permalink"></a></h3><p>The nudging towards &quot;climatology&quot; is an optional step to avoid issue (like sharp gradients) near the open sea boundaries. A flow relexation zone can be implemented in ROMS by using the followings settings:</p><pre><code class="nohighlight hljs">LtracerCLM == T T  ! enable processing of CLIM data
LnudgeTCLM == T T  ! nudge to CLIM data
TNUDG == 2*10.0d0                    ! days</code></pre><p>Make nudging on inflow is stronger than on outflow</p><pre><code class="nohighlight hljs">OBCFAC == 10.0d0                      ! nondimensional</code></pre><p>Set also <code>NUDNAME</code> to the file name create by the julia script.</p><h3 id="Run-ROMS"><a class="docs-heading-anchor" href="#Run-ROMS">Run ROMS</a><a id="Run-ROMS-1"></a><a class="docs-heading-anchor-permalink" href="#Run-ROMS" title="Permalink"></a></h3><h4 id="Run-ROMS-without-MPI"><a class="docs-heading-anchor" href="#Run-ROMS-without-MPI">Run ROMS without MPI</a><a id="Run-ROMS-without-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Run-ROMS-without-MPI" title="Permalink"></a></h4><ul><li>To run ROMS without MPI, one need to disable MPI in <code>build_roms.sh</code>. The ROMS binary will be called <code>romsS</code> and call be called by:</li></ul><pre><code class="language-bash hljs">./romsS &lt; roms.in | tee roms.out</code></pre><h4 id="Run-ROMS-with-MPI"><a class="docs-heading-anchor" href="#Run-ROMS-with-MPI">Run ROMS with MPI</a><a id="Run-ROMS-with-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Run-ROMS-with-MPI" title="Permalink"></a></h4><ul><li>How many CPU cores does your machine have? You can use the command <code>top</code> in a shell terminal followed by <code>1</code>.</li><li>In <code>build_roms.sh</code> set <code>USE_MPI=on</code> (which is actually the default value)</li><li>Recompile ROMS</li><li>Change in <code>roms.in</code> the parameters <code>NtileI</code> and <code>NtileJ</code>. The number of CPU cores should be <code>NtileI</code> * <code>NtileJ</code>.</li><li>Run ROMS with, e.g.</li></ul><pre><code class="language-bash hljs">mpirun -np 4 ./romsM  roms.in | tee roms.out</code></pre><p>where 4 is the number of cores to use. To use 4 CPUs, you need to set <code>NtileI</code> to 2 and <code>NtileJ</code> to 2.</p><p>With the command <code>tee</code> the normal screen output will be place in the file <code>roms.out</code> but still be printed on the screen.</p><ul><li><p>A problem? What does the error message say?</p></li><li><p>Outputs are in <code>roms_his.nc</code> and <code>roms_avg.nc</code>, plot some variables like sea surface height and sea surface temperature at the beginning and the end of the simulation.</p></li><li><p>In Julia, force figure 1 and to 2 to have the same color-bar.</p></li></ul><pre><code class="language-julia hljs">figure(); p1 = pcolor(randn(3,3)); colorbar()
figure(); p2 = pcolor(randn(3,3)); colorbar()
p2.set_clim(p1.get_clim())</code></pre><ul><li>If everything runs fine,<ul><li>is the model still stable with a longer time steps (<code>DT</code>) ?</li><li>increase the number of time steps (<code>NTIMES</code>)</li><li>possibly adapt the frequency at which you save the model results (<code>NHIS</code>, <code>NAVG</code>,<code>NRST</code>)</li></ul></li></ul><h3 id="Interpreting-ROMS-output"><a class="docs-heading-anchor" href="#Interpreting-ROMS-output">Interpreting ROMS output</a><a id="Interpreting-ROMS-output-1"></a><a class="docs-heading-anchor-permalink" href="#Interpreting-ROMS-output" title="Permalink"></a></h3><ul><li>Check minimum and maximum value of the different parameters</li></ul><pre><code class="nohighlight hljs"> NLM: GET_STATE - Read state initial conditions,             t = 57235 00:00:00
                   (Grid 02, File: roms_nest_his.nc, Rec=0182, Index=1)
                - free-surface
                   (Min = -4.63564634E-01 Max = -3.63838434E-01)</code></pre><ul><li>The barotropic, baroclinic and Coriolis Courant number should be smaller than 1</li></ul><pre><code class="nohighlight hljs"> Minimum barotropic Courant Number =  2.09670689E-02
 Maximum barotropic Courant Number =  5.56799674E-01
 Maximum Coriolis   Courant Number =  1.71574766E-03</code></pre><ul><li>Information<ul><li>energy (kinetic, potential, total) and volume</li><li>maximum Courant number</li></ul></li></ul><pre><code class="nohighlight hljs">   STEP   Day HH:MM:SS  KINETIC_ENRG   POTEN_ENRG    TOTAL_ENRG    NET_VOLUME  Grid
          C =&gt; (i,j,k)       Cu            Cv            Cw         Max Speed

 346200 57235 00:00:00  2.691184E-03  1.043099E+04  1.043099E+04  6.221264E+13  01
          (079,055,30)  9.266512E-02  4.949213E-02  0.000000E+00  1.081862E+00</code></pre><h3 id="Validation"><a class="docs-heading-anchor" href="#Validation">Validation</a><a id="Validation-1"></a><a class="docs-heading-anchor-permalink" href="#Validation" title="Permalink"></a></h3><p>Check out satellite data (e.g. sea surface temperature, sea surface height) at:</p><ul><li><a href="http://marine.copernicus.eu/">CMEMS</a></li><li><a href="https://podaac.jpl.nasa.gov/">PODAAC NASA</a></li></ul><p>Make some comparison with satellite and the downloaded in situ observation</p><h3 id="Hydrodynamic-model-troubleshooting"><a class="docs-heading-anchor" href="#Hydrodynamic-model-troubleshooting">Hydrodynamic model troubleshooting</a><a id="Hydrodynamic-model-troubleshooting-1"></a><a class="docs-heading-anchor-permalink" href="#Hydrodynamic-model-troubleshooting" title="Permalink"></a></h3><p><a href="https://github.com/gher-ulg/Documentation/wiki/Hydrodynamic-model-troubleshooting">Hydrodynamic model troubleshooting</a></p><h3 id="More-information"><a class="docs-heading-anchor" href="#More-information">More information</a><a id="More-information-1"></a><a class="docs-heading-anchor-permalink" href="#More-information" title="Permalink"></a></h3><ul><li><a href="https://www.myroms.org/wiki/">ROMS Wiki</a></li><li><a href="https://www.myroms.org/wiki/Frequently_Asked_Questions">ROMS Wiki Frequently Asked Questions</a></li><li>K. Hedström. 2016. <a href="https://github.com/kshedstrom/roms_manual/blob/master/roms_manual.pdf">Technical Manual for a Coupled Sea-Ice/Ocean Circulation Model (Version 4)</a>. U.S. Dept. of the Interior, Bureau of Ocean Energy Management, Alaska OCS Region. OCS, Study BOEM 2016-037. 176 pp.</li></ul></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Tuesday 21 February 2023 07:15">Tuesday 21 February 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
